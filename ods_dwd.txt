#create a table
hive -e "
CREATE TABLE IF NOT EXISTS dwd.dwd_fac_order_detailinfo_di (
    id STRING,
    order_amount DOUBLE,
    sku_num BIGINT,
    ds STRING,
    order_status STRING,
user_id bigint,
sku_id string,
province_id bigint
)
PARTITIONED BY (create_time STRING)
ROW FORMAT DELIMITED
FIELDS TERMINATED BY '\t';"



#!/bin/bash

# DWD

# optimization: set Hive to Dynamic partition mode
hive -e "
set hive.exec.dynamic.partition=true;
set hive.exec.dynamic.partition.mode=strict;
set hive.exec.max.dynamic.partitions.pernode=1000;

# create temp table with no partition but contain partion column (2023-04-01 change to cast(date_sub(current_date,1) as string) becomes dynamic partition)

CREATE TABLE IF NOT EXISTS dwd.temp_order_data AS
SELECT 
    t1.id,
    t1.original_total_amount AS order_amount,
    t2.sku_num,
    substr(t1.create_time, 1, 10) AS ds,
    t1.order_status,
    substr(t1.create_time, 1, 10) AS create_time,
    t1.user_id,
    t2.sku_id,
    t1.province_id
FROM
    tempo.order_info t1
JOIN
    tempo.order_detail t2
ON
    t1.id = t2.order_id
WHERE
    t1.create_time LIKE '2023-04-01%';

# temp table load data from ods to dwd

INSERT OVERWRITE TABLE dwd.dwd_fac_order_detailinfo_di PARTITION (create_time='2023-04-01')
SELECT
    id,
    order_amount,
    sku_num,
    ds,
    order_status,
    user_id,
    sku_id,
    province_id
FROM
    dwd.temp_order_data
WHERE
    ds='2023-04-01';

# delete temp table
DROP TABLE IF EXISTS dwd.temp_order_data;"
echo "complete"

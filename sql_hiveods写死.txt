#!/bin/bash

# 创建数组，包含所有要处理的表名
array=("ods_order_info" "ods_order_detail" "ods_base_province" "ods_base_region" "ods_base_category3" "ods_base_category2" "ods_base_category1" "ods_sku_info" "ods_user_info")


# 遍历数组中的每个表名
for i in ${array[*]}
do

# 根据表名选择相应的Sqoop导入命令
case $i in
  "ods_order_info")
# 获取 Hive 中最大 id
last_value=$(hive -e "SELECT MAX(id) FROM ods_order_info;")

# 检查 last_value 是否为空
if [ -z "$last_value" ]; then
`sqoop import --connect jdbc:mysql://localhost:3306/bigdata_project_OLAP --username root -password 123456 --query 'select id,create_time,province_id,order_status,user_id from order_info where $CONDITIONS' --fields-terminated-by '\t'  --target-dir /user/hive/warehouse/ods.db/ods_order_info  --delete-target-dir  -m 1`
else
# 执行 Sqoop 导入，使用 last_value 作为参数
sqoop import \
  --connect jdbc:mysql://localhost:3306/bigdata_project_OLAP \
  --username root \
  --password 123456 \
  --query "SELECT id,create_time,province_id,order_status,user_id FROM order_info WHERE id > $last_value AND \$CONDITIONS" \
  --target-dir /user/hive/warehouse/ods.db/ods_order_info \
  --incremental append \
  --check-column id \
  --last-value "$last_value" \
  --fields-terminated-by '\t' \
  -m 1
fi
  ;;
  "ods_sku_info")
   `sqoop import --connect jdbc:mysql://localhost:3306/bigdata_project_OLAP --username root -password 123456 --query 'select id,sku_name,category3_id from sku_info where $CONDITIONS' --fields-terminated-by '\t' --target-dir /user/hive/warehouse/ods.db/ods_sku_info --delete-target-dir  -m 1`
  ;;
  "ods_user_info")
    `sqoop import --connect jdbc:mysql://localhost:3306/bigdata_project_OLAP --username root -password 123456 --query 'select id,birthday,name,create_time from user_info where $CONDITIONS' --fields-terminated-by '\t' --target-dir /user/hive/warehouse/ods.db/ods_user_info --delete-target-dir  -m 1`
  ;;
   "ods_order_detail")
# 获取 Hive 中最大 id
last_value=$(hive -e "SELECT MAX(order_id) FROM ods_order_detail;")

# 检查 last_value 是否为空
if [ -z "$last_value" ]; then
`sqoop import --connect jdbc:mysql://localhost:3306/bigdata_project_OLAP --username root -password 123456 --query 'select order_id,order_price*sku_num,sku_num,sku_id from order_detail where $CONDITIONS' --fields-terminated-by '\t'  --target-dir /user/hive/warehouse/ods.db/ods_order_detail  --delete-target-dir  -m 1`
else
# 执行 Sqoop 导入，使用 last_value 作为参数
sqoop import \
  --connect jdbc:mysql://localhost:3306/bigdata_project_OLAP \
  --username root \
  --password 123456 \
  --query "SELECT id,order_price*sku_num,sku_num,sku_id FROM order_detail WHERE order_id > $last_value AND \$CONDITIONS" \
  --target-dir /user/hive/warehouse/ods.db/ods_order_detail \
  --incremental append \
  --check-column id \
  --last-value "$last_value" \
  --fields-terminated-by '\t' \
  -m 1
fi

  ;;
   "ods_base_region")
      `sqoop import --connect jdbc:mysql://localhost:3306/bigdata_project_OLAP --username root -password 123456 --query 'select id,region_name from base_region where $CONDITIONS' --fields-terminated-by '\t' --target-dir /user/hive/warehouse/ods.db/ods_base_region --delete-target-dir  -m 1`
  ;;
   "ods_base_province")
       `sqoop import --connect jdbc:mysql://localhost:3306/bigdata_project_OLAP --username root -password 123456 --query 'select id,name,region_id from base_province where $CONDITIONS' --fields-terminated-by '\t' --target-dir /user/hive/warehouse/ods.db/ods_base_province --delete-target-dir  -m 1`
   ;;
    "ods_base_category3")
       `sqoop import --connect jdbc:mysql://localhost:3306/bigdata_project_OLAP --username root -password 123456 --query 'select id,name,category2_id from base_category3 where $CONDITIONS' --fields-terminated-by '\t' --target-dir /user/hive/warehouse/ods.db/ods_base_category3 --delete-target-dir  -m 1`
   ;;
   "ods_base_category2")
      `sqoop import --connect jdbc:mysql://localhost:3306/bigdata_project_OLAP --username root -password 123456 --query 'select id,name,category1_id from base_category2 where $CONDITIONS' --fields-terminated-by '\t' --target-dir /user/hive/warehouse/ods.db/ods_base_category2 --delete-target-dir  -m 1`
   ;;
      "ods_base_category1")
      `sqoop import --connect jdbc:mysql://localhost:3306/bigdata_project_OLAP --username root -password 123456 --query 'select id,name from base_category1 where $CONDITIONS' --fields-terminated-by '\t' --target-dir /user/hive/warehouse/ods.db/ods_base_category1 --delete-target-dir  -m 1`
esac
# 检查上一个命令是否成功执行,成功与失败都会把日志记录导进日志表
if [$? -eq 0]
then
 `hive -e "insert into ods.log values (\"$i\",'import success',current_timestamp);"`
else
 `hive -e "insert into ods.log values (\"$i\",'import failed',current_timestamp);"`
fi
done
